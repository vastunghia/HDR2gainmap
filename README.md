# HDR2gainmap

A tiny command-line tool that turns HDR stills into **10‑bit HEIC with an Apple‑compatible gain map**.

- Use your own **SDR base** (PNG in Display P3) to control SDR appearance, **or**
- Let the tool **tone‑map** the SDR base from the HDR image.
- Derives **Maker Apple** metadata keys `33` and `48` from measured headroom (Apple’s piecewise mapping, clamped to **3 stops / 8×**).
  See Apple’s docs: <https://developer.apple.com/documentation/appkit/applying-apple-hdr-effect-to-your-photos>.
- Computes headroom via **peak‑max** (default) with a softening curve, or via a **robust percentile** (99.9th by default when enabled).
- Can emit a **clip mask** HEIC and/or a **masked SDR overlay** HEIC to visualize clipped areas (only when the SDR is **generated by the tool**).

---

## Features

- ✅ Apple Photos–friendly **HEIC (10‑bit Display P3)** with **embedded gain map** (works across iCloud).
- ✅ Two workflows: *HDR+SDR pair* **or** *HDR‑only with tone‑mapped SDR*.
- ✅ **Peak‑max** workflow by default (`--peak_max`) with configurable `--tonemap_ratio` (default **0.2**).
- ✅ Optional **percentile‑based headroom** (`--peak_percentile [value]`, default **99.9** if enabled).
- ✅ **Dry‑run** mode (`--tonemap_dryrun`) prints headroom & clip stats without writing HEICs.
- ✅ Optional **clip mask** (`--emit_clip_mask`) and **masked overlay** (`--emit_masked_image`) for debugging.
  - Both are written as **HEIC 10‑bit Display P3** using the same compression quality as the final output.
  - **Ignored** if an SDR companion image already exists (user‑provided SDR takes precedence).
- ✅ Strict validation (color space, orientation, size).
- ✅ **Maker Apple** metadata computed and **validated ex‑post**.
- ✅ Batch processing of all `*.png` in `./input_HDR`.

---

## Requirements

- **macOS 15+** (uses `CIToneMapHeadroom` and HDR gain‑map write options).
- Xcode Command Line Tools (for `swiftc`).
- Inputs are **PNG** files:
  - **HDR**: Display P3 **PQ** (tagged).
  - **SDR** (optional): Display **P3** (tagged).

---

## Folder Layout & Input Specs

```
./input_HDR/                 # HDR PNGs (required)
./input_SDR/                 # optional SDR PNGs (same basename as HDR)
./output_HDR_with_gainmap/   # output HEICs (final results)
./output_clipped_mask/       # clip masks (HEIC, created only if requested)
./output_clipped_overlay/    # SDR overlays (HEIC, created only if requested)
```

### HDR input (required)

- **Format:** PNG  
- **Color space:** Display P3 **PQ** (tagged)  
- **Naming:** `name.png` → output becomes `name.heic`  
- **Tip:** If your HDR PNGs are untagged, re‑export with an explicit Display P3 PQ profile.

### SDR input (optional, per image)

- **Format:** PNG  
- **Color space:** Display **P3** (tagged)  
- **Constraints:** **same basename**, **same dimensions**, **same orientation** as the HDR  
- If present, it is used as the **SDR base**. If absent, the tool **tone‑maps** the SDR base from HDR.

> **Note:** If an SDR is present, the options `--emit_clip_mask` and `--emit_masked_image` are **ignored** (the tool only visualizes clipping for SDRs it generates itself).

---

## How It Works (high‑level)

1. Scan `./input_HDR/` for `*.png`.
2. For each HDR:
   - If `./input_SDR/<same-name>.png` exists → **use it** (after checks).
   - Otherwise → **tone‑map** the HDR via `CIToneMapHeadroom` to create the SDR base.
3. Measure the peak in **linear P3** and compute **linear headroom**:
   - **Peak‑max** (default): take absolute max and apply a softening curve with `tonemap_ratio` (default **0.2**), or
   - **Percentile**: normalized linear‑luminance histogram (up to **2048 bins**) and a high percentile (default **99.9th** when enabled).
4. Convert headroom → **Maker Apple** keys (`33`, `48`) using Apple’s piecewise mapping  
   *(clamped to **3 stops** → **8×** headroom; validated ex‑post).*  
   Reference: Apple, **Applying Apple HDR effect to your photos**, section on encoding “stops” into `33`/`48`:  
   <https://developer.apple.com/documentation/appkit/applying-apple-hdr-effect-to-your-photos>
5. Build a temporary in‑memory HEIC from (SDR base + HDR) so Core Image **generates a gain map**.
6. Extract the **gain map** as an auxiliary image.
7. Write the final **HEIC (10‑bit Display P3)** with:
   - SDR base,  
   - explicit **gain map**,  
   - **Maker Apple** metadata.

---

## Lightroom Classic (RAW → HDR) Workflow Tips

If you develop RAW in **Adobe Lightroom Classic** on an HDR display:

1. Enable **“Preview for SDR displays”** while editing HDR to fine‑tune the SDR look.
2. Create **two export presets**:
   - **HDR preset** → exports **PNG HDR** to `./input_HDR/`  
     - Color space: **HDR Display P3 (PQ)**
   - **SDR preset** → exports **PNG SDR** to `./input_SDR/`  
     - Color space: **Display P3**  
     - **Same** pixel dimensions and orientation as the HDR
3. Apply both presets to all RAWs you want to publish with a gain map.  
   This gives you control over the SDR base embedded in the HEIC.

**Alternative:** Only export the **HDR PNG** to `./input_HDR/`.  
The tool will **tone‑map** the SDR base automatically.

> Tip: For the very best SDR control, create a virtual copy of the RAW as SDR, adjust it, and export it to `./input_SDR/`.

---

## Build & Run

### Compile

```bash
xcrun --sdk macosx swiftc -O -o hdr2gainmap BatchHDR2HEIC.swift
```

### Prepare folders

You can pre‑create all output folders, but it isn’t required.  
`output_clipped_mask` and `output_clipped_overlay` are created **only** if the related flags are used.

```bash
mkdir -p input_HDR input_SDR output_HDR_with_gainmap
```

### Run (basic)

```bash
./hdr2gainmap
```

Outputs to:

```
./output_HDR_with_gainmap/
# (the two debug folders are created on demand when their flags are used)
```

---

## Command‑line Options (snake_case)

```
Usage:
  hdr2gainmap [--suffix <text>] [--peak_percentile [value]] [--peak_max]
              [--tonemap_ratio <0..1>]
              [--heic_compression_quality <0..1>]
              [--tonemap_dryrun] [--emit_clip_mask]
              [--emit_masked_image [color]] [--debug]

Options:
  --suffix <text>                   Suffix appended to output filename (e.g. "_sdrtm")
  --peak_percentile [value]         Use percentile‑based peak (default 99.9 if value omitted)
  --peak_max                        Use absolute max + blend (tonemap_ratio applied)  [DEFAULT]
  --tonemap_ratio <0..1>            Blend curve for peak_max (default 0.2)
  --heic_compression_quality <q>    HEIC quality for final/mask/overlay in [0,1] (default 0.97)
  --tonemap_dryrun                  Only compute headroom + clipped fraction; no HEIC output
  --emit_clip_mask                  Write a black/white **HEIC** mask of clipped pixels
                                    (ignored if an SDR file already exists)
  --emit_masked_image [color]       Write an **HEIC** SDR image with clipped pixels painted solid
                                    (ignored if an SDR file already exists)
                                    Color can be a name (red, magenta, violet) or #RRGGBB (default: magenta)
  --debug                           Print verbose debug messages
  --help                            Show this message
```

### Examples

- **HDR‑only, peak‑max (default), HEIC quality 0.95, verbose:**
  ```bash
  ./hdr2gainmap --peak_max --heic_compression_quality 0.95 --debug
  ```

- **HDR‑only, robust percentile (99.9th), clip mask + overlay, verbose:**
  ```bash
  ./hdr2gainmap --peak_percentile --emit_clip_mask --emit_masked_image red --debug
  ```

- **Explicit percentile 99.0th, suffix appended:**
  ```bash
  ./hdr2gainmap --peak_percentile 99.0 --suffix _p99
  ```

- **Peak‑max method with a custom softening curve (0.3), dry‑run only:**
  ```bash
  ./hdr2gainmap --peak_max --tonemap_ratio 0.3 --tonemap_dryrun
  ```

---

## Output

- **HEIC**, 10‑bit (`RGB10`) **Display P3** base image.  
- Embedded **gain map** (explicit, platform‑native; not forced to RGB payload).  
- **Maker Apple** metadata keys `33` and `48`, consistent with the measured (clamped) headroom.  
- Optional debug HEICs (only when SDR is generated by the tool):
  - `output_clipped_mask/<name>_clipmask.heic` (white = clipped; black = not clipped),
  - `output_clipped_overlay/<name>_clippedOverlay.heic` (SDR with clipped pixels painted a solid color).

---

## Verify the Gain Map (Important)

On some systems (e.g., certain **Apple Silicon** models or **macOS** versions), the encoder may silently emit **SDR‑only HEICs without a gain map**. To **verify**:

1. Download Adobe’s **Gain Map Demo App for macOS**:  
   <https://www.adobe.com/go/gainmap_demoapp_mac>
2. Open your output `.heic` files in the app and confirm a **gain map is present**.
3. If the gain map is missing:
   - Try switching the final write from:
     ```swift
     writeHEIFRepresentation(...)
     ```
     to:
     ```swift
     writeHEIF10Representation(...)
     ```
     which can resolve encoder differences on some configurations.
   - Re‑run with `--debug` and open an issue including your **macOS version**, **Mac model (Intel/Silicon)**, and the **debug log**.

---

## Notes & Limitations

- **Maximum metadata headroom** in the Maker Apple mapping is **3 stops (8×)**.  
  If the measured headroom exceeds 8×, the tool **clamps metadata only** (the gain map can still encode broader dynamics).
- **Color tags are enforced**:
  - HDR must be **Display P3 PQ** (tagged).
  - SDR (if provided) must be **Display P3** (tagged).
  - Files with mismatched size/orientation are rejected.
- **Percentile headroom** uses a normalized linear‑luminance histogram (up to **2048 bins**) in extended linear P3.
- The **peak‑max** method applies a softening curve with `tonemap_ratio` (default **0.2**).

---

## Compatibility

- **Tested** on **Intel‑based Mac** running **macOS 15.7**.  
- On some **Apple Silicon** systems, switching to `writeHEIF10Representation` may be required (see above).

---

## Credits

Huge thanks to **chemharuka** for prior art and inspiration:  
<https://github.com/chemharuka/toGainMapHDR>

This project adapts and extends those ideas with:
- automatic Maker Apple metadata derivation (forward + inverse mapping),
- two peak measurement strategies (peak‑max and percentile),
- strict validation & ex‑post metadata checks,
- masks/overlays for debugging,
- batch processing, and an Apple‑friendly export path.

---

## License

MIT
